# ADR-001: Размещение функции оркестрации платёжных транзакций
## Общая информация 

1. Родительский артефакт - Архитектура платёжной системы OrchestrPay
2. Автор ADR - Команда OrchestrPay
3. Статус - **На согласовании**
4. Согласующие - Технический директор, Архитектор системы, Product Owner

## Контекст

### Описание задачи
Платёжная система OrchestrPay реализует процесс обработки платёжных транзакций, включающий взаимодействие с несколькими доменными сервисами:
- Сервис проведения платежей (Payment Processing Service)
- Сервис проверки на мошенничество (Fraud Detection Service)
- Сервис уведомлений (Notification Service)

Необходимо принять решение о том, где разместить логику оркестрации этих сервисов при обработке транзакций.

### Ключевые требования и ограничения

**Производительность:**
- SLA: менее 5 секунд в 90% случаев для успешных транзакций

**Надёжность и обработка ошибок:**
- Деньги не должны зависать между системами
- Стоимость ошибки при проведении транзакции значительно выше, чем потенциальная потеря от её отклонения
- Операции возврата должны выполняться автоматически без вовлечения службы поддержки

**Обработка исключительных сценариев:**
- Автоматические возвраты при сбоях системы
- Отмена транзакций по инициативе клиента
- Возвраты при обнаружении мошеннических операций (в момент транзакции и пост-фактум)
- Транзакции могут находиться в состоянии ожидания при ручной проверке
- Предусмотрен cut-off-time: по истечении времени ожидания ответа от проверочных сервисов транзакция считается разрешённой

## Рассмотренные варианты

### Вариант №1 «Оркестрация внутри доменного сервиса Payment Processing»

**Описание:**
Логика оркестрации размещается внутри основного сервиса обработки платежей (Payment Processing Service). Этот сервис становится центральной точкой координации всех операций платёжной транзакции.

**Архитектура:**
```
┌──────────────────────────────────────────────┐
│   Payment Processing Service                 │
│   ┌────────────────────────────────────┐     │
│   │  Orchestration Logic               │     │
│   │  - Transaction coordination        │     │
│   │  - Saga management                 │     │
│   │  - Compensation handling           │     │
│   └────────────────────────────────────┘     │
│                                              │
│   ┌────────────────────────────────────┐     │
│   │  Payment Business Logic            │     │
│   └────────────────────────────────────┘     │
└──────────────────────────────────────────────┘
         │          │
         ▼          ▼
    ┌────────┐ ┌──────────┐
    │ Fraud  │ │ Notify   │
    │ Check  │ │ Service  │
    └────────┘ └──────────┘
```

**Реализация:**
- Payment Processing Service содержит механизм Saga для управления распределённой транзакцией
- Сервис последовательно вызывает Fraud Detection и инициирует уведомления
- Компенсационная логика (возвраты) встроена в тот же сервис
- Управление таймаутами и cut-off-time реализовано внутри Payment Processing

### Вариант №2 «Выделенный сервис-оркестратор (Orchestration Service)»

**Описание:**
Создаётся отдельный независимый сервис, единственная ответственность которого — координация взаимодействия между доменными сервисами при обработке платёжных транзакций.

**Архитектура:**
```
┌──────────────────────────────────────────────┐
│   Payment Orchestration Service              │
│   ┌────────────────────────────────────┐     │
│   │  Orchestration Engine              │     │
│   │  - Workflow                        │     │
│   │  - Saga coordinator                │     │
│   │  - State management                │     │
│   │  - Compensation engine             │     │
│   │  - Timeout & cut-off handling      │     │
│   └────────────────────────────────────┘     │
└──────────────────────────────────────────────┘
         │         │          │
         ▼         ▼          ▼
    ┌─────────┐ ┌───────┐ ┌──────────┐
    │ Payment │ │ Fraud │ │ Notify   │
    │ Process │ │ Check │ │ Service  │
    └─────────┘ └───────┘ └──────────┘
```

**Реализация:**
- Orchestration Service содержит workflow-движок для управления процессами
- Payment Processing Service становится чисто доменным сервисом, отвечающим только за проведение платежей
- Оркестратор управляет последовательностью вызовов, обработкой ошибок и компенсациями
- Централизованное управление всеми сложными сценариями (возвраты, таймауты, компенсации)

## Сравнение альтернатив

| Вариант решения | Преимущества | Недостатки |
|-----------------|--------------|------------|
| **Вариант №1<br>Оркестрация внутри<br>Payment Processing** | - **Производительность**: меньше сетевых переходов, легче достичь SLA < 5 сек<br>- **Простота начальной реализации**: не требуется создавать новый сервис<br>- **Согласованность данных**: проще обеспечить транзакционность операций с платежами<br>- **Меньше точек отказа**: на один сервис меньше в цепочке вызовов<br>- **Низкая латентность**: прямое управление процессом без дополнительных хопов | - **Нарушение Single Responsibility Principle**: сервис отвечает и за бизнес-логику платежей, и за координацию<br>- **Низкая переиспользуемость**: логика оркестрации жёстко связана с конкретным доменом<br>- **Сложность поддержки**: изменения в процессе требуют модификации Payment Service<br>- **Масштабирование**: сложнее масштабировать отдельно логику оркестрации и обработки платежей<br>- **Риск монолита**: тенденция к накоплению слишком большой ответственности |
| **Вариант №2<br>Выделенный<br>Orchestration Service** | - **Separation of Concerns**: чёткое разделение ответственности между координацией и бизнес-логикой<br>- **Переиспользование**: оркестратор может координировать разные процессы (платежи, возвраты, подписки)<br>- **Гибкость изменений**: модификация процесса не затрагивает доменные сервисы<br>- **Централизованное управление**: вся логика компенсаций и обработки ошибок в одном месте<br>- **Независимое масштабирование**: можно масштабировать оркестратор и доменные сервисы отдельно | - **Дополнительная латентность**: лишний сетевой переход может влиять на достижение SLA<br>- **Усложнение архитектуры**: дополнительный сервис, требующий разработки, развёртывания и поддержки<br>- **Дополнительная точка отказа**: отказ оркестратора блокирует все транзакции<br>- **Распределённая транзакционность**: сложнее обеспечить строгую консистентность<br>- **Стоимость инфраструктуры**: дополнительные ресурсы для работы сервиса |

## Принятое решение

**Вариант №2: Выделенный сервис-оркестратор (Payment Orchestration Service)**

### Обоснование выбора

Несмотря на дополнительную сложность, выбор выделенного оркестратора обусловлен следующими критическими факторами:

- Критичность надёжности над производительностью
- Сложность сценариев возвратов
- Управление таймаутами и cut-off-time
- Долгосрочная масштабируемость и развитие

### Риски и план митигации

| Риск | Митигация |
|------|-----------|
| Дополнительная латентность может нарушить SLA | - Deployment в той же AZ<br>- Параллельное выполнение проверок<br>- Постоянный мониторинг производительности |
| Оркестратор как single point of failure | - Health checks и автоматический failover<br>- Circuit breaker patterns |
| Повышенная сложность разработки | - Использование готовых Saga движков<br>- Подробная документация процессов<br>- Автоматизированное тестирование |

### Дата принятия решения
19 декабря 2025 г.
